<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controller</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="geo.js"></script>
    <style>
        #map {
            height: 600px;
        }
    </style>
</head>

<body>

</body>

<div id="map"></div>

<script>
    // Leaflet
    const center = {
        lat: 48.9315,
        lng: 2.3590
    };

    const parcURL = 'https://opendata.hauts-de-seine.fr/api/records/1.0/search/?dataset=fr-219200631-parcs&q=&facet=nom_village';
    const planURL = 'https://opendata.hauts-de-seine.fr/api/records/1.0/search/?dataset=plans-topographiques-des-parcs-et-jardins&q=';
    
    const mapDefault = L.tileLayer(layerDefault.url);
    const wordlStreet = L.tileLayer(layerWorldStreet.url);

    const map = L.map('map', {
        center: center,
        zoom: 10,
        layers: [mapDefault],
    });

    L.marker(center).addTo(map);

    function mapParc(item) {
        return {
            name: item.fields.libelle,
            coords: item.fields.geo_point_2d,
            street: item.fields.lib_voie_complet_min,
            color: 'blue'
        }
    }

    function mapPlan(item) {
        return {
            name: item.fields.parc,
            coords: item.fields.geo_point,
            street: '',
            color: 'red',
        }
    }

    function createIcon(color) {
        return L.icon({
                iconUrl: `img/marker-${color}.svg`,
                iconSize: [36, 36],
                iconAnchor: [36/2,36],
                popupAnchor: [0,-36]
            });
    }

    async function getData(url) {
        const response = await fetch(url);
        return await response.json();
    }

    async function main() {
        const parc = await getData(parcURL);
        const plan = await getData(planURL);

        const parcData = parc.records.map(mapParc);
        const planData = plan.records.map(mapPlan);
        const data = [...parcData, ...planData];
        const markers = [];

        data.forEach(item => {
            const m = L.marker(item.coords, {
                icon: createIcon(item.color),
            }).bindPopup(`
                <h2>${item.name}</h2>
                ${item.street}
            `);

            markers.push(m);
        });

        const group = L.featureGroup(markers).addTo(map);
        map.fitBounds(group.getBounds());

        const mapCtrlGroup = {
            'Carte par d√©faut': mapDefault,
            'World Street': wordlStreet
        };

        const markerCtrlGroup = {
            'blue': group,
            'rouge': group,
        }

        L.control.layers(mapCtrlGroup, markerCtrlGroup, {
            collapsed: false,
            position: 'bottomright'
        }).addTo(map);
    }



    main();

</script>

</html>